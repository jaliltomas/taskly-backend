// Prisma schema for WhatsApp Price Catalog
// PostgreSQL with pgvector extension

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model Provider {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  phoneNumber String   @unique @map("phone_number") @db.VarChar(50)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  priceHistory PriceHistory[]
  rawMessages  RawMessage[]
  products     ProductUnique[] @relation("BestProvider")

  @@index([phoneNumber])
  @@map("providers")
}

model Category {
  id                   Int      @id @default(autoincrement())
  name                 String   @unique @db.VarChar(100)
  description          String?  @db.VarChar(500)
  markupRetail         Float    @default(0.15) @map("markup_retail")
  markupReseller       Float    @default(0.05) @map("markup_reseller")
  isRetailPercentage   Boolean  @default(true) @map("is_retail_percentage")
  isResellerPercentage Boolean  @default(true) @map("is_reseller_percentage")
  createdAt            DateTime @default(now()) @map("created_at")

  products ProductUnique[]

  @@map("categories")
}

model ProductUnique {
  id                     Int      @id @default(autoincrement())
  nameNormalized         String   @map("name_normalized") @db.VarChar(500)
  categoryId             Int?     @map("category_id")
  embedding              Unsupported("vector(768)")?
  lastPrice              Float    @default(0) @map("last_price")
  bestProviderId         Int?     @map("best_provider_id")
  suggestedPriceRetail   Float    @default(0) @map("suggested_price_retail")
  suggestedPriceReseller Float    @default(0) @map("suggested_price_reseller")
  metadata               Json?    @db.JsonB
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  category     Category?      @relation(fields: [categoryId], references: [id])
  bestProvider Provider?      @relation("BestProvider", fields: [bestProviderId], references: [id])
  priceHistory PriceHistory[]

  @@map("products_unique")
}

model PriceHistory {
  id         Int      @id @default(autoincrement())
  productId  Int      @map("product_id")
  providerId Int      @map("provider_id")
  rawName    String   @map("raw_name") @db.VarChar(500)
  price      Float
  createdAt  DateTime @default(now()) @map("created_at")

  product  ProductUnique @relation(fields: [productId], references: [id], onDelete: Cascade)
  provider Provider      @relation(fields: [providerId], references: [id])

  @@index([productId])
  @@index([createdAt(sort: Desc)])
  @@map("price_history")
}

model RawMessage {
  id            Int      @id @default(autoincrement())
  providerId    Int?     @map("provider_id")
  phoneNumber   String   @map("phone_number") @db.VarChar(50)
  content       String   @db.Text
  status        String   @default("pending") @db.VarChar(20)
  productsCount Int      @default(0) @map("products_count")
  errorMessage  String?  @map("error_message") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  provider Provider? @relation(fields: [providerId], references: [id])

  @@index([status])
  @@index([providerId])
  @@map("raw_messages")
}
